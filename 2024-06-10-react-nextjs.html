<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />

    <title>React/Next.js Workshop</title>

    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui"
    />
    <link rel="stylesheet" href="slides/revealjs/reveal.js/dist/reset.css" />
    <link rel="stylesheet" href="slides/revealjs/reveal.js/dist/reveal.css" />
    <link
      rel="stylesheet"
      href="slides/revealjs/reveal.js/dist/theme/solarized.css"
    />

    <!-- Theme used for syntax hislides/ghlighted code -->
    <link
      rel="stylesheet"
      href="slides/revealjs/highlight-js-github-theme.css"
    />
    <link rel="stylesheet" href="slides/revealjs/styles.css" />
  </head>

  <body>
    <div class="reveal">
      <!-- Any section element inside of this container is displayed as a slide -->
      <div class="slides">
        <section data-state="title">
          <h2 class="title" style="font-size: 7rem">
            <b>React/Next.js Workshop</b>
          </h2>

          <h4>
            <span class="transparent-bg">
              <a href="https://nilshartmann.net" target="_blank"
                >Nils Hartmann</a
              >
              |
              <a href="https://twitter.com/nilshartmann" target="_blank"
                >@nilshartmann</a
              >
            </span>
          </h4>
          <p style="margin-top: 4rem"></p>
          <div>
            <h3><span class="transparent-bg">Repository</span></h3>
            <p>
              <span class="transparent-bg"
                >Remote:
                <a href="https://github.com/nilshartmann/nextjs-react-workshop"
                  >https://github.com/nilshartmann/nextjs-react-workshop</a
                ></span
              >
            </p>
          </div>
          <p style="margin-top: 4rem"></p>
          <div>
            <h3><span class="transparent-bg">Slides</span></h3>
            <p>
              <span class="transparent-bg"
                >Remote:
                <a
                  href="https://nilshartmann.github.io/nextjs-react-workshop/2024-06-10-react-nextjs.html"
                  >https://nilshartmann.github.io/nextjs-react-workshop/2024-06-10-react-nextjs.html</a
                ></span
              >
            </p>
          </div>
        </section>
        <section>
          <h2>Nils Hartmann</h2>
          <p>
            <a href="https://nilshartmann.net" target="_blank"
              >https://nilshartmann.net</a
            >
            /
            <a href="https://twitter.com/nilshartmann" target="_blank"
              >@nilshartmann</a
            >
          </p>
          <p>
            <em
              >Freiberuflicher Software-Entwickler, Berater und Trainer aus
              Hamburg</em
            >
          </p>

          <div style="display: flex; justify-content: center">
            <div>
              <p>Java</p>
              <p>JavaScript, TypeScript</p>
              <p>React</p>
              <p>Single-Page-Applications</p>
              <p>GraphQL</p>
              <p style="margin-top: 20px">
                <a href="https://nilshartmann.net/workshops"
                  >Schulungen und Workshops</a
                >
              </p>
            </div>
            <div style="margin-left: 15px">
              <a href="https://reactbuch.de"
                ><img
                  style="max-height: 450px"
                  src="slides/images/react-buch-v2.jpg"
                /><br />https://reactbuch.de</a
              >
              <br />
            </div>
          </div>
        </section>

        <!-- ============================================================================= -->
        <section>
          <h2>Formales</h2>
          <p class="fragment">Bitte schaltet Euer Video ein üôè</p>
          <p class="fragment">
            <b>Jederzeit:</b> Fragen und Diskussionen! Bringt euch gerne ein.
          </p>
          <p class="fragment">Motto: Es gibt keine dummen Fragen!</p>
          <p class="fragment">
            Bemerkbar machen per Audio, "Hand heben" oder Chat
          </p>
          <p class="fragment">
            <img width="50%" src="slides/images/zoom-reaktionen.png" />
          </p>
        </section>
        <section data-markdown>
          <textarea data-template>
### Formales: Zeitplan
* Montag und Dienstag, 10. und 11. Juni
* jeweils 09.00 Uhr bis ca. 16.30 Uhr
  * 12.30 bis 13.30 Uhr Mittagspause üçù
  * Kurze Pausen zwischendurch ‚òïÔ∏è

---
## Agenda
<!-- .slide: class="no-fragment xleft" -->
* **React und Next.js**
  * Server Components
  * Arbeiten mit Daten (APIs, asynchroner Code)
  * Fehlerhandling
  * Server Actions und Formulare (mit React 19)
* **React Vertiefung**
  * [Seiteneffekte mit useEffect](#/t-use-effect)
  * [Context API](#/t-context)
  * [Render Performance optimieren](#/t-performance)
* **Eure Fragen, Themen und W√ºnsche**
  * jederzeit!

---
### Kurze Vorstellung
<!-- .slide: class="with-fragments" -->
* Stellt euch doch bitte kurz vor...
  * Was sind eure Vorkenntnisse/Schwerpunkte?
    * Frontend? Backend? React? Next.js? Java? Spring? ...
---
### Zum Ankommen...
<!-- .slide: class="with-fragments" -->
- √ñffne bitte das Miro-Board
- Schreibe (mindestens) ein Thema oder eine Frage auf, das wir besprechen sollten, damit sich f√ºr dich der Workshop gelohnt hat
  * Schlagworte reichen
  * Kann aus allen Bereichen rund um React, Next.js, TypeScript, ... sein
---
### Kurze Vorstellung #2
<!-- .slide: class="with-fragments" -->
* Architektur eurer Anwendung(en)
  * Welche Prozesse/Services gibt es?
  * Wie kommunizieren die Anwendungen untereinander?
  * Welche APIs gibt es zwischen den Anwendungen?



          </textarea>
        </section>

        <section data-markdown="slides/grundlagen-rsc.md"></section>
        <section>
          <h1>React Details</h1>
        </section>

        <section id="t-use-effect">
          <h3>Seiteneffekte</h3>
          <ul>
            <li>
              Als <b>Side effect</b> bzw. <b>Seiteneffekt</b> (k√∂nnte im
              deutschen auch mit "Nebenwirkung" √ºbersetzt werden) wird in React
              Code bezeichnet, der Dinge au√üerhalb der umschlie√üenden
              Komponenten-Funktion ver√§ndert.
            </li>
            <li>
              Beispiele sind: Manipulation des nativen DOM (z.B. Fenster-Titel
              setzen), einen Timer starten oder einen Server-Aufruf durchf√ºhren
            </li>
            <li>
              Seiteneffekte sind in der <b>Renderphase</b> einer Komponente
              verboten! üö®
            </li>
          </ul>
        </section>

        <section>
          <h3>useEffekt-Hook</h3>
          <p>
            <em
              >Mit useEffekt kann eine Funktion registriert werden, die nach dem
              Rendern der Komponente ausgef√ºhrt wird</em
            >
          </p>
          <p>
            Diese <b>Effekt-Callback</b>-Funktion wird beim <em>commit</em> der
            Komponente ausgef√ºhrt
          </p>
          <p>
            Wie alle anderen Hooks, ist <code>useEffect</code> nur in
            Client-Komponenten erlaubt.
          </p>

          <div>
            <pre><code class="javascript"  >
            function App(props) {
              React.useEffect(
                () => console.log("I will run on EACH commit")
              );
            }
          </code></pre>
          </div>
          <div>
            2. Parameter (leeres Array) gibt an, dass die Funktion nur einmal
            ausgef√ºhrt werden soll
            <pre><code class="javascript"  >
              function App(props) {
                React.useEffect(
                  () => console.log("I will run only on 1st commit"),
                  []
                );
              }
            </code></pre>
          </div>
        </section>

        <section>
          <h3>useEffect Hook</h3>

          <p>Zwei Parameter:</p>
          <ol>
            <li>
              Callback-Funktion, die aufgerufen wenn entsprechendes Ereignis
              eintritt (z.B. initiales Rendern abgeschlossen)
            </li>
            <li>
              Ein Array mit Abh√§ngigkeiten:
              <ul>
                <li>
                  Wenn kein Array angegeben wird, wird der Effekt nach jedem
                  Rendern ausgef√ºhrt (achtung! Endlosschleife m√∂glich)
                </li>
                <li>
                  Wenn ein leeres Array angegeben wird, wird der Effekt nur nach
                  dem 1. Rendern ausgef√ºhrt
                </li>
                <li>
                  Wenn Werte angegeben werden, wird der Effekt ausgef√ºhrt, wenn
                  sich mind 1 Wert ver√§ndert hat
                </li>
                <li>
                  <b>Wichtig!</b> <em>Alle</em> Werte im Dependency-Array
                  angeben, die darin verwendet werden (Werte aus Props, State,
                  ...)
                </li>
              </ul>
            </li>
          </ol>
        </section>
        <section data-markdown>
          <textarea data-template>
### useEffect Hook: Clean-up Funktion

* Um auf das Entfernen der Komponente aus dem DOM zu reagieren (z.B Resourcen
freigeben), kann die Callback-Funktion als R√ºckgabe eine "Clean-Up"-Funktion zur√ºckliefern:
  * ```javascript
    function HelloEffect() {
      React.useEffect(
        () => {
          console.log("Ich bin gemounted worden");
          return () => console.log("Ich bin entfernt worden")
        },
        [])
      );
    }
  ```
* Die Clean-Up-Funktion wird immer ausgef√ºhrt, wenn die Komponente aus dem DOM entfernt wird
              und bevor der Effekt erneut ausgef√ºhrt wird.
* Mit der Clean-up-Funktion kann also immer die letzte Ausf√ºhrung des Effekt-Callbacks "aufger√§umt" werden
  * ```javascript
    function PostEditor() {
      const [title, setTitle] = useState("");

      React.useEffect(
        () => {
          let currentTitle = title;
          console.log("Title: ", currentTitle);
          return () => console.log("Title war beim Commit:", currentTitle)
        },
        [ title ])
      );
    }
    ```

</textarea
          >
        </section>

        <section>
          <h3>Beispiel: Aktualisieren des Browsertitels</h3>

          <div>
            <p>
              Der eingegebene Post-Titel soll auch in der Titelzeile des
              Browsers erscheinen.
            </p>
            <pre><code class="javascript"  >
                function PostEditor() {
                  const [title, setTitle] = React.useState("");
                  const [body, setBody] = React.useState("");

                  React.useEffect(() => {
                    // Aktuellen Titel merken
                    const currentTitle = window.document.title;
                    window.document.title = `New Post ${title}`;

                    // Nach dem Unmount bzw. erneuten Ausf√ºhrung des Effekts
                    // Titel wieder auf urspr√ºnglichen Wert zur√ºcksetzen
                    return () => window.document.title = currentTitle;


                  }, [title]);

                  return <div>...</div>

                }

                </code></pre>
          </div>
        </section>

        <section data-markdown="">
          <textarea data-template>
### React Strict Mode

* React kann in einem [Strict Mode](https://react.dev/reference/react/StrictMode) ausgef√ºhrt werden
* Dann wird so getan, als ob jede Komponente zweimal gerendert wird
* Dadurch sollen Resource Leaks auffallen
* Per default ist der Strict Mode in Next.js eingeschaltet, aber man kann [ihn ausschalten](https://nextjs.org/docs/app/api-reference/next-config-js/reactStrictMode)
  * Im unserem Workspace ist der Strict Mode *aus*geschaltet
  </textarea
          >
        </section>

        <section data-markdown>
          <textarea data-template>
### √úbung: useEffect

* Verwende useEffect, um den Browser Tab-Titel zu setzen
* Kopiere dir den Code aus `10_effect/20_uebung/00_initial` in dein `app`-Verzeichnis
  * Die URL ist: http://localhost:3000/editor
* Implementiere die fehlende Funktionalit√§t in `app/editor/page.tsx`
  * Dort findest Du TODOs
* Optionale Aufgabe nur machen, wenn noch Zeit ist.
* Wenn du fertig bist, bitte in Zoom die ‚úã heben.
          </textarea>
        </section>

        <!-- ============================================================================== -->
        <!-- ====                                                                      ==== -->
        <!-- ====            C O N T E X T                                             ==== -->
        <!-- ====                                                                      ==== -->
        <!-- ============================================================================== -->
        <section id="t-context">
          <h3>Hintergrund: Daten und State</h3>
          <ul>
            <li>Serverseitige <b>Daten</b> und clientseitiger <b>State</b></li>
            <li>Arten von State: <b>lokal</b> und <b>global</b></li>
            <li>√úberblick: üëâ Daten und State</li>
          </ul>
        </section>
        <section>
          <h3>Hintergrund: Globaler Zustand</h3>
          <ul>
            <li>
              Man kann Zustand in <b>lokalen Zustand</b> und
              <b>globalen Zustand</b> einteilen
            </li>
            <li>
              <b>Lokaler Zustand</b> ist Zustand, der "mehr oder weniger" einer
              Komponente zur Verf√ºgung steht
            </li>
            <li>
              <b>Globaler Zustand</b> hingegen ist f√ºr die ganze Anwendung oder
              gro√üe Teile davon zust√§ndig
            </li>
            <li>Die √úbgerg√§nge sind flie√üend, es gibt keine fixe Definition</li>
            <li>
              Beispiele f√ºr globalen Zustand: angemeldeter Benutzer, Theme
            </li>
          </ul>
        </section>
        <section>
          <h2>React Context API</h2>
          <p>Kein Statemanagement, aber h√§ufig zusammen erw√§hnt</p>
          <p>"Dependency Injection"</p>
          <p>√úberblick: üëâ Anwendungshierachie mit State und Props (Miro)</p>
        </section>

        <!-- ============================================================================= -->

        <section>
          <h2>Im Detail: Context API</h2>
          <p>Beispiel: <code>context_app/workspace</code></p>
          <p>
            In <code>Container.tsx</code> Anzeige der Border einschalten (<code
              >hideBorder = false</code
            >)
          </p>
          <p><code>CounterApp</code> rendern!</p>
          <p>
            In <code>Container.tsx</code> Anzeige der Renderings einschalten
            (<code>showRenderings = true</code>)
          </p>
          <p>
            (Material in
            <code>context-example/material/CounterContext.txt</code>)
          </p>
        </section>

        <section>
          <h2>Context...</h2>
          <p>
            <em
              >erlaubt das Durchreichen von Informationen ohne explizites
              angeben als Properties</em
            >
          </p>

          <ul>
            <li>funktioniert nur innerhalb einer Hierarchie-Ebene</li>
            <li>funktioniert nur in <b>Client Komponenten</b></li>
            <li>
              es k√∂nnen beliebg viele (fachliche) Context definiert werden
            </li>
            <li>besteht aus <code>Provider</code> und <code>Consumer</code></li>
            <li>
              <a
                href="https://react.dev/learn/passing-data-deeply-with-context"
                target="_blank"
                >Doku</a
              >
            </li>
          </ul>
        </section>

        <section>
          <h2>Context Factory</h2>
          <ul>
            <li>
              <em>erzeugt ein Objekt, mit <b>zwei Komponenten</b></em>
            </li>
            <li>
              <code>Provider</code>, stellt Objekt mit Key-Value-Paaren zur
              Verf√ºgung (der Context-"Value")
            </li>
            <li>
              <code>Consumer</code> wird in eigener Komponente verwendet, um auf
              einen Context zuzugreifen ("versteckt" durch useContext Hook)
            </li>
            <li>
              <pre><code class="line-numbers" data-leftpad>
import react from "React";

const AuthContext = React.createContext();

// erzeugt:
// AuthContext.Provider 
// AuthContext.Consumer (mit Hooks API √ºberfl√ºssig)

export AuthContext;
                      </code></pre>
            </li>
          </ul>
        </section>

        <section data-markdown>
          <textarea data-template>
## Context Factory mit TypeScript

* Der `createContext` kann ein Typ-Parameter √ºbergeben werden, der den Context-Wert beschreibt
* `createContext` ben√∂tigt dann einen Default-Wert, der diesem Typen entspricht
  * Der Default-Wert wird in der Anwendung in der Regel nicht verwendet
  * Wird nur verwendet, wenn (f√§lschlich) auf den Kontext zugegriffen wird, ohne dass es einen Provider
    gibt
* ```typescript
  type IAuthContext = { 
    username: string | null;
    onLogin(newUser: string): void;
    onLogout(): void;
  }

  const AuthContext = React.createContext<IAuthContext>({
    // Dummy-Implementierung vom Default Context
    username: null,
    onLogin() {},
    onLogout() {}
  });

  export AuthContext;
  ```

          </textarea>
        </section>

        <section data-markdown>
          <textarea data-template>
## Context Provider

* _Eine React-Komponente, die einen Context zur Verf√ºgung stellt_
  * wird innerhalb einer eigenen Komponente eingebunden und zur√ºckgeliefert
  * Nimmt ein Objekt ("Context") mit beliebigen Werten entgegen (`value`-Property)
  * Woher die Werte kommen (State, Props, anderer Kontext, ...) spielt keine Rolle!
  * Alle Eintr√§ge des Objektes sind f√ºr die Konsumenten verf√ºgbar
* ```typescript
  const AuthContext = React.createContext&lt;IAuthContext>(/*...*/); // wie gesehen

  type AuthProviderProps = {
    children: React.ReactElement
  }

  export function AuthProvider(props: AuthProviderProps) {
      const [ currentUser, setCurrentUser ] = React.useState(null);

      const contextValue: IAuthContext = {
        // the current user
        currentUser,

        // function to set new user
        function onLogin(name) { setCurrentUser(name) },
        function onLogout() { setCurrentUser(null) }
      };

      return &lt;AuthContext.Provider value={contextValue}>
        {props.children}
      &lt;/AuthContext.Provider>;
  }             
  ```
  </textarea
          >
        </section>

        <section>
          <h2>useContext-Hook</h2>
          <p><em>Zugriff auf die Werte aus dem Context</em></p>
          <p>
            In allen Komponenten unterhalb der Provider Komponente, kann mit
            <code>useContext</code> auf den Kontext zugegriffen werden
          </p>

          <pre><code class="javascript">
import { AuthContext } from "auth-context";

function UserBadge() {
  const { currentUser } = React.useContext(AuthContext);

  return currentUser  ? &lt;h1>Welcome, {currentUser}&lt;h1> : null;
}            
          </code></pre>

          <p>Aufrufen einer Funktion aus dem Context</p>
          <p>√Ñndert im Context den Zustand der Provider-Komponente</p>
          <p>
            Alle Konsumer werden neu gerendert und k√∂nnen den neuen Wert
            verwenden
          </p>
          <pre><code class="javascript">
function UserBadge() {
  const { currentUser, logout } = React.useContext(AuthContext);

  return currentUser  ? 
    &lt;>&lt;h1>Welcome, {currentUser}&lt;h1>&lt;button onClick={logut}>Logout&lt;/button>&lt;/> 
    : null;
}                
          </code></pre>
        </section>
        <section data-markdown>
          <textarea data-template>
## Neu in React 19

* `Context.Provider` -> `Context` (?)
* Zugriff auf den Context mit `use`-Hook
  * `context authContext = use(AuthContext)`
          </textarea>
        </section>

        <section data-markdown>
          <textarea data-template>
## Zugriff mit Custom Hook

* √úbliches Pattern: f√ºr den Zugriff auf den Context wird ein eigener Hook zur Verf√ºgung gestellt
* ```typescript
  export function useAuthContext(): IAuthContext {
    const authContext = useContext(AuthContext);

    return authContext;
  }            
  ```
* ```typescript
  import { useAuthContext } from "auth-context";
  
  export default function UserBadge() {
    const authContext = useAuthContext();
  }
  ```  

  * "Versteckt" den Context (Implementierungsdetail!) vor der Anwendung
  * Sieht aus wie fachliche API
  * Kann (vergleichsweise einfach) gemockt werden
---
###  Zugriff mit Custom Hook in TypeScript
* Beim Erzeugen des Context muss man (in TypeScript) einen Default Context angeben:
* ```typescript
  const defaultContext: IAuthContext = {
      // Dummy-Implementierung vom Default Context
      username: null, onLogin() {}
  }
  const AuthContext = React.createContext<IAuthContext>(defaultContext);
  ```
* Das ist nicht immer (sinnvoll) m√∂glich, so dass man auch `ContextType | null` verwenden k√∂nnte:
* ```typescript
  const AuthContext = React.createContext<IAuthContext | null>(null);
  ```
* Nun liefert `useContext` aber immer auch `null` zur√ºck, so dass die Verwendung jedes Mal √ºberpr√ºft werden muss:
* ```typescript
  function UserBadge() {
    const { username } = useContext(AuthContext); // ERR: Property 'username' does not exist on type 'IAuthContext | null'
  }
  ```
 
* Mit dem Custom Hook kann eine Plausibilit√§tspr√ºfung durchgef√ºhrt werden und ggf. ein sprechender Fehler erzeugt werden:
* ```typescript
  
  export function useAuthContext(): IAuthContext {
    const authContext = useContext(AuthContext);

    if (authContext === null) {
      throw new Error("AuthContext not correctly initialized. Please wrap your application in a AuthContextProvider component");
    }

    return authContext;
  }            
  ```  

---
### Ein "halbglobaler" Context
<!-- .slide: class="left" -->
* Ein Formular hat eine beliebige Menge von Feldern und Button
* Kann man da mit Context was machen? ü§î

* ```typescript
  
    type FormState = Record<string, string>;

    function PersonForm() {
      const [formState, setFormState] = React.useState<FormState>({});

      function onClearForm() {
        setFormState({});
      }

      function onFieldChange(fieldname: string, value: string) {
        setFormState({
          ...formState,
          [fieldname]: value
        });
      }

      return (
        <Container title="PersonForm">
          <FieldSet>
            <Input name="firstname" formState={formState} onFieldChange={onFieldChange} />
            <Input name="lastname" formState={formState} onFieldChange={onFieldChange} />
          </FieldSet>
          <ClearButton onClearForm={onClearForm} />
        </Container>
      );
    }

  ```

---
## √úbung: Ein Notification Context

* *Baue einen Kontext, der eine globale Notification anzeigt*
* <!-- .element: class="demo" -->Ergebnis zeigen
* Schritte:
  * In `20_context/workspace` bitte Abh√§ngigkeiten installieren und Next.js starten:
  * ```bash
    cd 20_context/workspace

    pnpm install
    pnpm dev
    ```
* In `NotificationContext.tsx` soll ein Context implementiert werden, der Informationen
            √ºber die anzuzeigene Notification enth√§lt
* In `NotificationApp.tsx` sind React-Komponenten implementiert. Diese sollen den Context dann nutzen
* Wo ziehst du die Trennung zwischen Client- und Server-Komponente mit `use client`?
* N√§here Informationen findest Du direkt in beiden Dateien
* Du solltest mit der Implementierung des `NotificationContext` anfangen
* M√∂gliche L√∂sung findest Du in `material/02_solution`
* Wenn Du fertig bist, bitte "Hand heben" in Zoom üôãÔ∏è

---
### Renderverhalten von Context

* Lasst uns mal √ºberlegen, ob es sinnvoll ist, f√ºr die Verwendung unseres `NotificationContext` mehrere Hooks zu bauen:
  * zum Beispiel zum Setzen des Context
  * zum Beispiel zum Zugriff nur auf die √ºbersetzte Message
  * ...oder auch nur auf die Information, ob √ºberhaupt etwas gesetzt ist
* hilft uns das beim Optimieren des Renderings? ü§î
* was f√ºr einen Vor- oder Nachteil h√§tte dieser Ansatz dar√ºberhinaus? ü§î
---
### Renderverhalten von Context

* Bei jeglicher √Ñnderung des Contexts werden immer alle Konsumenten neu gerendert
  * unabh√§ngig davon, ob diese sich f√ºr den Teil interessieren, der sich ge√§ndert hat
  * das k√∂nnen wir nicht vermeiden (evtl. in einer kommenden React Version)
* Aus diesem Grund sollte man den Context nicht unbedingt verwenden, wenn
  * darin Daten enthalten sind die sich h√§ufig bzw. schnell √§ndern (Inhalt eines Eingabefeldes z.B.)
  * und von diesen √Ñnderungen sehr viele Komponenten betroffen sind (direkt oder indirekt)

---
### Renderverhalten von React
* <!-- .element: class="demo" -->In CounterContextProvider "Container" um children setzen
* <!-- .element: class="demo" -->Wann wird gerendert, wenn wir z.B. den lokalen App-State ver√§ndern ü§î
* <!-- .element: class="demo" -->Hello World-Beispiel:
  * Zwei Server-Komponenten: Hello- und GoodbyeMessage
  * Client-Komponente "Greeter" mit boolean State; zeigt entweder Hello- oder Goodbye an
  * Was passiert, wenn wir die Komponenten direkt in Greeter rendern?
  * Was passiert, wenn wir die aus unserer page-Komponente direkt √ºbergeben?
  * Was passiert, wenn wir HelloMessage in page.tsx und in Greeter rendern?
  * üí° Eine Komponente kann theoretisch Server- und Client-Komponente sein
* <!-- .element: class="demo" -->"50_global": Context in einer App mit Server- und Client-Komponenten
* <!-- .element: class="demo" -->"50_global": Provider hier im Layout

---
### Renderverhalten von React
* Der "Lebenszyklus" einer Komponente h√§ngt an der verwendenden Komponente
* Man kann "fertig" gerenderte Komponenten an andere Komponenten per Property √ºbergeben
  * Die werden von der Komponente dann "nur" eingef√ºgt, aber der Lebensyzklus ist davon unabh√§ngig
* Fertig gerenderte **Server-Komponenten** k√∂nnen an **Client-Komponenten** √ºbergeben werden

          </textarea>
        </section>

        <section data-markdown>
          <textarea data-template>
## Error Boundaries
* ü§îWas passiert, wenn wir in unserer App vergessen, den `NotificationContextProvider` einzubinden? ü§î
* <!-- .element: class="demo" -->Ausprobieren (NotificationApp.tsx)
* <!-- .element: class="demo" -->Error Boundary (React): NotificationApp_mitErrorBoundary.tsx
* <!-- .element: class="demo" -->Error Boundary (Next.js): error.tsx
---
## Error Boundaries

* Wenn beim **Rendern** etwas schiefgeht, verwirft React "zur Sicherheit" den ganzen Komponenten-Tree
  * (damit nicht z.B. inkonsistente oder fehlerhafte Daten angezeigt werden)
* Das ist nicht besonders benutzerfreundlich
* In einem Event-Handler haben wir dieses Problem nicht: dort k√∂nnen wir z.B. mit try/catch arbeiten
  * oder der Event-Handler wird einfach abgebrochen und die "alte" UI bleibt weiterhin sichtbar
* Beim Rendern k√∂nnen wir aber kein try/catch drumherum legen
* Deswegen gibt es "spezielle" Komponenten: **Error Boundaries**
---
### Error Boundaries
* Error Boundary-Komponenten kann man √ºberall in seiner Komponenten-Hierarchie einziehen
* Render-Fehler, die unterhalb auftreten, werden dann der Error Boundary-Komponente √ºbergeben
  * Diese kann dann z.B. eine Fehler-Komponente darstellen
  * Dieses Verhalten √§hnelt try-catch.
  * Auch try-catch-Bl√∂cke in "normalem" Code k√∂nnt ihr ja auf jeder Ebene des Call-Stacks einziehen
* Ein Beispiel:
* ```typescript
  function MyApp() {
    return (
      <Layout>
        <Header />
        <MyErrorBoundary>
            <Main>
              <BlogPost />
            </Main>
            <NewsletterForm />
        </MyErrorBoundary>
      </Layout>
    )
  }
  ```
* Wenn es hier zum Fehler **w√§hrend des Renderns** kommt:
  * innerhalb von `Layout` oder `Header`: wei√üe Seite, Fehlermeldung auf der Console
  * innerhalb von `Main`, `BlogPost` oder `NewsletterForm`: Error Boundary wird angezeigt, `Layout` und `Header`-Komponente bleiben unver√§ndert (gerendert)
---
### Fehlerbehandlung in Next.js

- In Next.js k√∂nnt ihr Fehler auf Routen-Ebene mit einer [`error.tsx` Datei behandeln](https://nextjs.org/docs/app/building-your-application/routing/error-handling)
- Diese Datei muss eine **Client Komponente** exportieren
- Die Komponente wird von Next.js als Error Boundary-Komponente um eure komplette Route gelegt
- Die Komponente bekommt zwei Properties √ºbergeben: `error` und `reset`
  - `error` ist das `Error`-Objekt, das den Fehler ausgel√∂st hat
  - `reset` ist eine Callback-Funktion, die ihr verwenden k√∂nnt, um den Fehler zu verwerfen
- Wenn eine Route _keine_ `error.tsx`-Datei hat, sucht Next.js in den oberen Verzeichnissen, bis eine Komponente gefunden wird
  - sonst wird Default-Fehler angezeigt

---
### Error Boundaries
* Behandlung der Fehler auf Routen-Ebene ist m√∂glicherweise zu grob granular
* Ihr k√∂nnt auch einzelne Komponenten mit eigenen Error Boundaries umschliessen
* Eine Error Boundary-Komponente ist eine Art `catch`-Block f√ºr die Renderphase von Komponente
* Technisch handelt es sich dabei um eine fast "normale" React-Komponente
* Diese muss allerdings noch mit der (alten) React JavaScript Klassen API gebaut werden
* Diese Klasse muss dann die [getDerivedStateFromError](https://react.dev/reference/react/Component#static-getderivedstatefromerror) Callback-Funktion implementieren
* Einfacher ist es, eine fertige Error Boundary-Komponente zu verwenden: [react-error-boundary](https://github.com/bvaughn/react-error-boundary)
---
### Error Boundary mit `react-error-boundary`
* Die Error Boundary-Komponente aus der Bibliothek hei√üt - √úberraschung! - `ErrorBoundary`
* Die ist sehr flexibel zu konfigurieren
* Man muss ihr mit dem Property [FallbackComponent eine Komponente √ºbergeben](https://github.com/bvaughn/react-error-boundary?tab=readme-ov-file#errorboundary-with-fallbackcomponent-prop), die im Falle eines Fehlers gerendert werden soll
  * (das ist euer "try-Block")
* Diese Komponente bekommt dann als Property u.a. den Fehler √ºbergeben:
* ```typescript
  import { FallbackProps } from "react-error-boundary";

  function AppErrorMessage( { error }: FallbackProps) {

    console.error("Something bad happend:", error);
    return <h1>Something bad happend !</h1>;
  }
  ```
* ```typescript
  import { ErrorBoundary } from "react-error-boundary";
  function MyApp() {
    return (
      <Layout>
        <Header />
        <ErrorBoundary fallback={AppErrorMessage}>
            <Main>
              <BlogPost />
            </Main>
            <NewsletterForm />
        </ErrorBoundary>
      </Layout>
    )
  }

  ```
---
### react-error-boundary
* Der `FallbackComponent`-Komponente wird √ºberdies eine Funktion `resetErrorBoundary` √ºbergeben
* Die k√∂nnt ihr aufrufen, dann wird erneut versucht, den Komponenten-Tree unterhalb der `ErrorBoundary`-Komponente zu rendern
* Das macht Sinn wenn es Grund zur Annahme gibt, der Fehler verschwinde sp√§ter (z.B. Netzwerkverbindung ist wieder in Ordnung)
* ```typescript
  import { FallbackProps } from "react-error-boundary";

  function AppErrorMessage( { error, resetErrorBoundary }: FallbackProps) {

    console.error("Something bad happend:", error);
    return (
      <div>
        <h1>Something bad happend !</h1>
        <button onClick={ () => resetErrorBoundary() }>Try again!</button>
      </div>
    );
  }
  ```
* Wenn ihr eine M√∂glichkeit habt, einen fehlerhaften Zustand zu reparieren, k√∂nnt ihr an der `ErrorBoundary`-Komponente eine `onReset`-Funktion angeben
* Diese wird dann aufgerufen, wenn ihr `resetErrorBoundary` in der Fallback-Komponente aufruft
---
### react-error-boundary

* Normalerweise werden Error Boundary-Komponenten von React nur dargestellt, wenn ein Fehler **beim Rendern** auftritt
* Die `ErrorBoundary`-Komponente von `react-error-boundary` k√∂nnt ihr aber auch manuell rendern lassen, wenn z.B. in einem Event ein Fehler auftritt.
  * So k√∂nnt ihr eure Fehlerbehandlung dann auf alle Arten von Fehlern in eurer Anwendung anwenden
* Um die `ErrorBoundary`-Komponente anzuzeigen, verwendet ihr den `useErrorBoundary`-Hook:
* ```typescript
  import { useErrorBoundary } from "react-error-boundary";

  function PostEditor() {
    const { showBoundary } = useErrorBoundary();

    async function saveBlogPost() {
      try {
        await fetch("...");
      } catch (e) {
        showBoundary("Could not save blog post");
      }
    }
    return ...;
  }
  ```
* Genau wie bei Error Boundaries, die beim Rendern aktiv werden, wir hier auch die n√§chsth√∂here `ErrorBoundary`-Komponente angezeigt

---
### √úbung: Error Boundaries
- Kopiere `20_error_boundary/00_initial/app` in deine Anwendung
- Wenn Du `http://localhost:3000/a/b/counter` aufrufst, bekommst du eine Counter-Komponente angezeigt
- Diese sollst du mit einem Error Boundary umschliessen, so dass nicht die ganze Seite durch eine Fehler-Komponente ersetzt wird
- Siehe dazu TODOs in `counter/Counter.tsx`
- M√∂gliche L√∂sung: `20_error_boundary/02_error_boundary`
- Wenn Du fertig bist, bitte die Hand in Zoom heben ‚úã


---
### Ausblick: Fehler protokollieren
* <!-- .element: class="demo" --> `20_error_boundary/03_log_error`
* Ihr k√∂nnt die Error Boundaries nutzen, um die Fehler auf dem Server zu protokollieren
* Zum Zugriff auf dem Server k√∂nnt ihr eine Server Action nehmen
  * oder einen eigenen HTTP-Endpunkt (Next.js API Route z.B.)
* Das ist in jedem Fall ein Seiteneffekt, d.h. mit `useEffect` ummanteln!
* Achtung! Dabei sicherstellen, dass es bei Fehlern beim Protokollieren nicht zu Folge-Fehlern kommt...
* Aufpassen, welche Informationen ihr an das Backend schickt (nicht, dass da z.B. ein Passwort im Fehlertext vorkommt)
  * (Das gilt auch f√ºr Fehler, die das Backend an den Client schickt!)
  * Immer nur so wenig wie m√∂glich Informationen √ºber die Leitung schicken

  </textarea
          >
        </section>

        <section data-markdown="" id="t-performance">
          <textarea data-template>
## Performance Tuning
### Renderverhalten in React (Client) Komponenten
---
### Renderverhalten
* Wenn eine Komponente ihren State √§ndert, werden alle Kind-Komponenten auch neu gerendert
* Das **kann** zu Performance-Problemen in gro√üen Hierarchien f√ºhren
  * Wenn man kein Problem hat, muss man nichts tun
* <!-- .element: class="demo" --> 99_memo
---
### Renderverhalten
* Damit React (memo, useCallback etc.) feststellen kann, ob sich etwas ver√§ndert hat, m√ºssen Objekte **immutable** sein
* Das bedeutet, dass ihr Objekte und Arrays nicht direkt ver√§ndert, sondern kopiert und dann ver√§ndert

---
### Performance Tuning
* Mit `useCallback` und `useMemo` k√∂nnt ihr in einer Komponente verhindern, dass Daten bzw. Funktionen mit jedem Rendern neu erzeugt werden
  * Ihre Referenzen bleiben dann stabil und evtl. spart ihr Performance
* Mit `memo` k√∂nnt ihr eine Komponente "memoisieren".
  * Sie wird dann nur neugerendert, wenn sich mindestens ein Property ver√§ndert hat
  * Wichtig: die Properties werden mit [Object.is](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/is) verglichen
  * (u.a.) deswegen nie Objekte direkt ver√§ndern
---
### Ausblick: React Compiler
* Das React-Team arbeitet an einem [Compiler](https://react.dev/learn/react-compiler), der uns viel arbeit abehmen wird
* Dieser wird das Memoisieren von Daten, Funktionen und Komponenten f√ºr euch automatisch in den Code schreiben
* Der Compiler ist zzt. noch in arbeit, man geht aber davon aus, dass er dieses Jahr noch erscheinen wird
* In Next.js 15 RC ist der [Compiler mit einem "experimental" Flag](https://nextjs.org/blog/next-15-rc#react-compiler-experimental) bereits verf√ºgbar
<!-- .element: class="demo" --> Demo
  </textarea
          >
        </section>

        <!-- ============================================================================= -->
        <section>
          <h2>Geschafft! üòä</h2>
          <h3>Vielen Dank f√ºr Eure Teilnahme!</h3>
          <h3>Viel Spa√ü und Erfolg mit React!</h3>
          <p>Wenn ihr noch Fragen habt, k√∂nnt ihr mich erreichen:</p>
          <p>
            Mail:
            <a href="mailto:nils@nilshartmann.net">nils@nilshartmann.net</a>
          </p>
          <p>
            Web:
            <a href="https://nilshartmann.net" target="_blank"
              >https://nilshartmann.net</a
            >
          </p>
          <p>
            Twitter:
            <a href="https://twitter.com/nilshartmann" target="_blank"
              >@nilshartmann</a
            >
          </p>
        </section>
      </div>
    </div>

    <script src="slides/revealjs/reveal.js/dist/reveal.js"></script>
    <script src="slides/revealjs/reveal.js/plugin/notes/notes.js"></script>
    <script src="slides/revealjs/reveal.js/plugin/markdown/markdown.js"></script>
    <script src="slides/revealjs/reveal.js/plugin/highlight/highlight.js"></script>
    <script src="slides/revealjs/config.js"></script>
  </body>
</html>
